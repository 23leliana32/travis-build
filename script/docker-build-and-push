#!/bin/bash

set -ev

local_image="travisbuild_${app_name}" # Docker Compose removes dashes and expects the name to end with the build app name
quay_image=quay.io/travisci/travis-build
tag_name=$(echo "$TRAVIS_BRANCH" | sed -e "s/\\//-/g")

unset DOCKER_CERT_PATH
unset DOCKER_HOST
unset DOCKER_TLS
unset DOCKER_TLS_VERIFY

docker build -t "${quay_image}:${tag_name}" .

docker images

docker tag "${quay_image}:${tag_name}" "${quay_image}:${TRAVIS_COMMIT:0:7}"

docker login -u="${QUAY_ROBOT_HANDLE}" -p="${QUAY_ROBOT_TOKEN}" quay.io

docker push "${quay_image}:${TRAVIS_BRANCH}"
docker push "${quay_image}:${TRAVIS_COMMIT:0:7}"

if [[ "${TRAVIS_BRANCH}" == "master" ]]; then
  docker tag "${local_image}" "${quay_image}:latest"
  docker push "${quay_image}:${TRAVIS_BRANCH}"
fi

exit 0
